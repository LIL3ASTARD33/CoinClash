<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Coin Clash</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ----------- GLOBAL ----------- */
* { box-sizing: border-box; }
body {
  font-family: Arial, sans-serif;
  background: #050814;
  color: #f5f5f5;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}
.game-container {
  background: #0d1020;
  border-radius: 16px;
  padding: 20px;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 0 30px rgba(0,0,0,0.6);
}
h1 {
  text-align: center;
  margin-top: 0;
  margin-bottom: 10px;
}

/* ----------- BALANCE ----------- */
.balance-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 15px;
  font-size: 14px;
  opacity: 0.9;
}
.balance-value {
  font-weight: bold;
  font-size: 16px;
}

/* ----------- INPUTS ----------- */
label { font-size: 14px; display: block; margin-bottom: 5px; }
input, button {
  width: 100%; padding: 10px; margin-bottom: 12px;
  border-radius: 8px; border: none; font-size: 14px;
}
input {
  background: #090c18;
  color: #f5f5f5;
}
button {
  background: #2f7dfc;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: 0.1s ease;
}
button:hover:not(:disabled) {
  transform: translateY(-1px);
}
button:disabled { opacity: 0.5; }

/* ----------- MULTIPLIERS ----------- */
.multiplier-row { margin-bottom: 12px; }
.multiplier-label { font-size: 14px; margin-bottom: 6px; }
.multiplier-buttons {
  display: flex; flex-wrap: wrap; gap: 6px;
}
.mult-btn {
  flex: 1 1 calc(25% - 6px);
  padding: 6px;
  border-radius: 999px;
  background: #11162b;
  color: #ffffff;
  font-size: 11px;
  cursor: pointer;
  text-align: center;
  transition: 0.15s ease;
}
.mult-btn.active {
  background: #2f7dfc;
  transform: translateY(-1px);
}

/* ----------- COIN & ANIMATION ----------- */
.coin-area {
  margin: 18px 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  height: 180px;
  position: relative;
  overflow: visible;
}

.coin {
  width: 80px; height: 80px;
  background: radial-gradient(circle at 30% 30%, #ffe9a3, #e0aa3e, #825a1b);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  font-weight: bold;
  border: 3px solid rgba(255,255,255,0.25);
  position: absolute;
  bottom: 0;
  transition: transform 0.3s ease;
}

/* Cartoon "motion trail" behind coin */
.motion-trail {
  position: absolute;
  width: 90px;
  height: 20px;
  background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
  border-radius: 20px;
  opacity: 0;
  transform: rotate(-20deg);
  pointer-events: none;
}

/* Toss animation */
.coin.tossing {
  animation: coinToss 1.2s cubic-bezier(.29,.59,.42,1.35) forwards;
}
.motion-trail.active {
  animation: trailFlash 0.4s ease forwards;
}

/* Coin spins fast in cartoon style */
@keyframes coinToss {
  0%   { bottom: 0; transform: rotateY(0deg) scale(1); }
  40%  { bottom: 120px; transform: rotateY(900deg) scale(1.1); }
  70%  { bottom: 40px; transform: rotateY(1500deg) scale(0.95); }
  100% { bottom: 0; transform: rotateY(1800deg) scale(1); }
}

@keyframes trailFlash {
  0% { opacity: 0; transform: translateX(0) rotate(-20deg); }
  50% { opacity: 1; transform: translateX(-30px) rotate(-20deg); }
  100% { opacity: 0; transform: translateX(-60px) rotate(-20deg); }
}

.coin-label { font-size: 13px; opacity: 0.8; margin-top: 100px; }

.result { text-align: center; min-height: 22px; margin-bottom: 6px; font-size: 14px; }
.result.win { color: #4ade80; }
.result.lose { color: #f97373; }

.error { font-size: 12px; color: #f97373; min-height: 18px; margin-bottom: 4px; }

.info-line { font-size: 12px; text-align: center; opacity: 0.7; margin-top: 4px; }
.fairness { font-size: 10px; opacity: 0.6; margin-top: 6px; word-break: break-all; }

</style>
</head>

<body>
<div class="game-container">
  <h1>Coin Clash</h1>

  <div class="balance-row">
    <span>Balance:</span>
    <span class="balance-value" id="balanceDisplay">$1,000.00</span>
  </div>

  <label>Bet Amount</label>
  <input type="number" id="betAmount" value="10" min="0.10" step="0.01" />

  <div class="multiplier-row">
    <div class="multiplier-label">Target Multiplier</div>
    <div class="multiplier-buttons" id="multiplierButtons">
      <button class="mult-btn active" data-mult="1.93">1.93x</button>
      <button class="mult-btn" data-mult="2">2x</button>
      <button class="mult-btn" data-mult="3">3x</button>
      <button class="mult-btn" data-mult="5">5x</button>
      <button class="mult-btn" data-mult="10">10x</button>
      <button class="mult-btn" data-mult="25">25x</button>
      <button class="mult-btn" data-mult="50">50x</button>
      <button class="mult-btn" data-mult="100">100x</button>
      <button class="mult-btn" data-mult="250">250x</button>
      <button class="mult-btn" data-mult="500">500x</button>
      <button class="mult-btn" data-mult="1000">1,000x</button>
      <button class="mult-btn" data-mult="5000">5,000x</button>
      <button class="mult-btn" data-mult="10000">10,000x</button>
    </div>
  </div>

  <button id="betButton">Bet</button>

  <div class="coin-area">
    <div class="motion-trail" id="trail"></div>
    <div class="coin" id="coin">?</div>
    <div class="coin-label" id="coinLabel">Waiting for bet...</div>
  </div>

  <div class="result" id="resultText"></div>
  <div class="error" id="errorText"></div>

  <div class="info-line">
    House edge ≈ 3% on every multiplier (win chance = 0.97 / M).
  </div>

  <div class="fairness" id="fairnessInfo"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const API_URL = "http://localhost:8000/play";

  let balance = 1000.00;
  let selectedMultiplier = 1.93;

  const balanceDisplay = document.getElementById("balanceDisplay");
  const betAmount = document.getElementById("betAmount");
  const betButton = document.getElementById("betButton");
  const resultText = document.getElementById("resultText");
  const errorText = document.getElementById("errorText");
  const coin = document.getElementById("coin");
  const coinLabel = document.getElementById("coinLabel");
  const fairnessInfo = document.getElementById("fairnessInfo");
  const trail = document.getElementById("trail");

  // Sounds
  const betSound = new Audio("audio/bet.wav");
  const winSound = new Audio("audio/win.wav");
  const loseSound = new Audio("audio/lose.wav");

  const multButtons = document.getElementById("multiplierButtons");

  multButtons.addEventListener("click", (e) => {
    const btn = e.target.closest(".mult-btn");
    if (!btn) return;
    selectedMultiplier = parseFloat(btn.dataset.mult);
    document.querySelectorAll(".mult-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  });

  function formatMoney(v) { return "$" + v.toFixed(2); }
  function updateBal() { balanceDisplay.textContent = formatMoney(balance); }
  updateBal();

  function clientSeed() {
    return Date.now() + "-" + Math.floor(Math.random() * 1e6);
  }

  function playTrail() {
    trail.classList.remove("active");
    void trail.offsetWidth;
    trail.classList.add("active");
  }

  async function playRound() {
    errorText.textContent = "";
    resultText.textContent = "";
    fairnessInfo.textContent = "";

    let bet = parseFloat(betAmount.value);
    if (isNaN(bet) || bet < 0.1) return errorText.textContent = "Invalid bet.";
    if (bet > balance) return errorText.textContent = "Insufficient balance.";

    balance -= bet;
    updateBal();
    betSound.play();

    betButton.disabled = true;

    // Cartoon toss animation
    coin.textContent = "";
    coin.classList.remove("tossing");
    void coin.offsetWidth;
    coin.classList.add("tossing");
    playTrail();

    const cSeed = clientSeed();

    let data = null;

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bet, multiplier: selectedMultiplier, client_seed: cSeed })
      });

      data = await res.json();
    } catch (e) {
      errorText.textContent = "Server error.";
      balance += bet;
      updateBal();
      betButton.disabled = false;
      return;
    }

    // Reveal AFTER toss finishes
    setTimeout(() => {

      if (data.did_win) {
        balance += data.payout;
        updateBal();
        coin.textContent = "H";
        coinLabel.textContent = "Heads — You win!";
        winSound.play();

        resultText.className = "result win";
        resultText.textContent =
          `WIN! Roll ${data.roll.toFixed(4)} < ${data.win_chance.toFixed(4)} — Won ${formatMoney(data.payout)}`;
      } else {
        coin.textContent = "T";
        coinLabel.textContent = "Tails — You lose.";
        loseSound.play();

        resultText.className = "result lose";
        resultText.textContent =
          `LOSS. Roll ${data.roll.toFixed(4)} ≥ ${data.win_chance.toFixed(4)}`;
      }

      fairnessInfo.textContent =
        `Provably Fair — server_hash: ${data.server_seed_hash} | client_seed: ${cSeed} | nonce: ${data.nonce}`;

      betButton.disabled = false;

    }, 1200); // after animation finishes
  }

  betButton.addEventListener("click", playRound);

});
</script>

</body>
</html>
